#!/bin/sh
#
# cloud-install - Cloud installer
#
# Copyright 2014 Canonical, Ltd.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

if [ ! $(id -u) = 0 ]; then
    echo "Installing a cloud requires root privileges. Rerun with sudo."
    exit 1
fi

set -ex

. /usr/share/cloud-installer/common/common.sh
. /usr/share/cloud-installer/common/display.sh
. /usr/share/cloud-installer/common/maas.sh
. /usr/share/cloud-installer/common/juju.sh
. /usr/share/cloud-installer/common/configure.sh
. /usr/share/cloud-installer/common/multi.sh
. /usr/share/cloud-installer/common/single.sh
. /usr/share/cloud-installer/common/landscape.sh

startLog

trap exitInstall EXIT
trap "" PIPE

#disableBlank


if [ ! -e /etc/.cloud-installed ]; then
	configureInstall
	case $install_type in
	Multi-system)
		multiInstall
		;;
	"Single system")
		singleInstall
		;;
	"Landscape managed")
		landscapeInstall
		;;
	*)
		# install cancelled by user
		exit 0
		;;
	esac
	touch /etc/.cloud-installed
else
	echo "Cloud already installed."
fi
exitInstall
cd "/home/$INSTALL_USER"; exec sudo -H -u "$INSTALL_USER" cloud-status
