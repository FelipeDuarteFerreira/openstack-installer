#!/usr/bin/env python2.7
# -*- mode: python; -*-
#
# maas-upload-file - File uploads to MAAS
#
# Copyright 2014 Canonical, Ltd.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This package is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.


"""Upload files to MAAS.

TODO: Remove once LP#1187826 is Fix Released.

This is a workaround while file uploads don't work via maas-cli; see
https://bugs.launchpad.net/maas/+bug/1187826 for details.
"""

import argparse
import urllib2

from MultipartPostHandler import MultipartPostHandler

from apiclient.maas_client import MAASOAuth

class HTTPMAASOAuthProcessor(urllib2.BaseHandler):

    def __init__(self, consumer_key, resource_token, resource_secret):
        self.auth = MAASOAuth(consumer_key, resource_token, resource_secret)

    def http_request(self, req):
        headers = {}
        self.auth.sign_request(req.get_full_url(), headers)
        for name, value in headers.iteritems():
            req.add_header(name, value)
        return req

parser = argparse.ArgumentParser(description="Upload file to MAAS")
parser.add_argument("url", metavar="URL", help="MAAS URL")
parser.add_argument("credentials", help="MAAS credentials")
parser.add_argument("name", help="Target file name")
parser.add_argument("file", help="File to upload")

args = parser.parse_args()

opener = urllib2.build_opener(MultipartPostHandler,
                              HTTPMAASOAuthProcessor(*args.credentials.split(":")))
params = {"filename": args.name, "file": open(args.file, "rb")}
opener.open(args.url + "/files/?op=add", params)
